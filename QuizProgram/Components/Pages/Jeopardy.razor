@page "/jeopardy"
@rendermode InteractiveServer
@inject IQuizContainer quizContainer
@inject IQuizService quizService
@inject IGameService gameService
@inject IJSRuntime JSRuntime

<div class="bg-video">
    <video id="bgVideo" autoplay muted playsinline loop preload="auto">
        <source src="video/wallpaper.mp4" type="video/mp4" />
    </video>
</div>

<h1>@_quiz.QuizName</h1>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <td width="250">Halfblood prince</td>
                <td width="250">Hogwarts History</td>
                <td width="250">Muggles World</td>
                <td width="250">Four Houses of Hogwarts</td>
                <td width="250">Random Pipes</td>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="@GetTileTdClass(1, "Halfblood prince")">
                    <p @onclick="@(() => OnTileClick(1, "Halfblood prince"))">100</p>
                </td>
                <td class="@GetTileTdClass(1, "Hogwarts History")">
                    <p @onclick="@(() => OnTileClick(1, "Hogwarts History"))">100</p>
                </td>
                <td class="@GetTileTdClass(1, "Muggles World")">
                    <p @onclick="@(() => OnTileClick(1, "Muggles World"))">100</p>
                </td>
                <td class="@GetTileTdClass(1, "Four Houses of Hogwarts")">
                    <p @onclick="@(() => OnTileClick(1, "Four Houses of Hogwarts"))">100</p>
                </td>
                <td class="@GetTileTdClass(1, "Random Pipes")">
                    <p @onclick="@(() => OnTileClick(1, "Random Pipes"))">100</p>
                </td>
            </tr>
            <tr>
                <td class="@GetTileTdClass(2, "Halfblood prince")">
                    <p @onclick="@(() => OnTileClick(2, "Halfblood prince"))">200</p>
                </td>
                <td class="@GetTileTdClass(2, "Hogwarts History")">
                    <p @onclick="@(() => OnTileClick(2, "Hogwarts History"))">200</p>
                </td>
                <td class="@GetTileTdClass(2, "Muggles World")">
                    <p @onclick="@(() => OnTileClick(2, "Muggles World"))">200</p>
                </td>
                <td class="@GetTileTdClass(2, "Four Houses of Hogwarts")">
                    <p @onclick="@(() => OnTileClick(2, "Four Houses of Hogwarts"))">200</p>
                </td>
                <td class="@GetTileTdClass(2, "Random Pipes")">
                    <p @onclick="@(() => OnTileClick(2, "Random Pipes"))">200</p>
                </td>
            </tr>
            <tr>
                <td class="@GetTileTdClass(3, "Halfblood prince")">
                    <p @onclick="@(() => OnTileClick(3, "Halfblood prince"))">300</p>
                </td>
                <td class="@GetTileTdClass(3, "Hogwarts History")">
                    <p @onclick="@(() => OnTileClick(3, "Hogwarts History"))">300</p>
                </td>
                <td class="@GetTileTdClass(3, "Muggles World")">
                    <p @onclick="@(() => OnTileClick(3, "Muggles World"))">300</p>
                </td>
                <td class="@GetTileTdClass(3, "Four Houses of Hogwarts")">
                    <p @onclick="@(() => OnTileClick(3, "Four Houses of Hogwarts"))">300</p>
                </td>
                <td class="@GetTileTdClass(3, "Random Pipes")">
                    <p @onclick="@(() => OnTileClick(3, "Random Pipes"))">300</p>
                </td>
            </tr>
            <tr>
                <td class="@GetTileTdClass(4, "Halfblood prince")">
                    <p @onclick="@(() => OnTileClick(4, "Halfblood prince"))">400</p>
                </td>
                <td class="@GetTileTdClass(4, "Hogwarts History")">
                    <p @onclick="@(() => OnTileClick(4, "Hogwarts History"))">400</p>
                </td>
                <td class="@GetTileTdClass(4, "Muggles World")">
                    <p @onclick="@(() => OnTileClick(4, "Muggles World"))">400</p>
                </td>
                <td class="@GetTileTdClass(4, "Four Houses of Hogwarts")">
                    <p @onclick="@(() => OnTileClick(4, "Four Houses of Hogwarts"))">400</p>
                </td>
                <td class="@GetTileTdClass(4, "Random Pipes")">
                    <p @onclick="@(() => OnTileClick(4, "Random Pipes"))">400</p>
                </td>
            </tr>
            <tr>
                <td class="@GetTileTdClass(5, "Halfblood prince")">
                    <p @onclick="@(() => OnTileClick(5, "Halfblood prince"))">500</p>
                </td>
                <td class="@GetTileTdClass(5, "Hogwarts History")">
                    <p @onclick="@(() => OnTileClick(5, "Hogwarts History"))">500</p>
                </td>
                <td class="@GetTileTdClass(5, "Muggles World")">
                    <p @onclick="@(() => OnTileClick(5, "Muggles World"))">500</p>
                </td>
                <td class="@GetTileTdClass(5, "Four Houses of Hogwarts")">
                    <p @onclick="@(() => OnTileClick(5, "Four Houses of Hogwarts"))">500</p>
                </td>
                <td class="@GetTileTdClass(5, "Random Pipes")">
                    <p @onclick="@(() => OnTileClick(5, "Random Pipes"))">500</p>
                </td>
            </tr>
        </tbody>
    </table>
</div>

@if (_showVideo)
{
    <div class="video-container" @onclick="HideQuestion">
        <video id="bookVideo" class="fullscreen-video" autoplay muted playsinline>
            <source src="video/book.mp4" type="video/mp4" />
        </video>

        <div class="overlay-text @textClass" @onclick:stopPropagation="true">
            <h2>@_question.Text</h2>
        </div>

        <div class="award-wrapper" @onclick:stopPropagation="true">
            <div class="award-panel">
                <div class="award-title">Award @CurrentQuestionPoints points</div>

                <label class="house-tick gryff">
                    <input type="checkbox" @bind="_awardTicks[House.Gryffindor]" />
                    Gryffindor
                </label>

                <label class="house-tick slyth">
                    <input type="checkbox" @bind="_awardTicks[House.Slytherin]" />
                    Slytherin
                </label>

                <label class="house-tick raven">
                    <input type="checkbox" @bind="_awardTicks[House.Ravenclaw]" />
                    Ravenclaw
                </label>

                <label class="house-tick huff">
                    <input type="checkbox" @bind="_awardTicks[House.Hufflepuff]" />
                    Hufflepuff
                </label>

                <button class="award-btn" @onclick="AwardPointsAsync">Award points</button>
            </div>
        </div>
    </div>
}


@if (_showHouseCup)
{
    <div class="housecup-overlay">
        <div class="housecup-card">
            <div class="housecup-title">House Cup</div>

            <div class="cups">
                @foreach (var col in HouseCupColumns())
                {
                    <div class="tube @col.Css"
                         data-delta="@col.Delta"
                         data-points="@col.To">

                        <div class="tube-frame"></div>

                        <div class="tube-glass">
                            <div class="diamond-layer"></div>
                            <div class="tube-highlight"></div>
                        </div>

                        <div class="tube-cap top"></div>
                        <div class="tube-cap bottom"></div>

                        <div class="tube-badge">
                            <div class="tube-house">@col.Label</div>
                            <div class="tube-score">@col.To</div>
                        </div>
                    </div>
                }
            </div>
            <div class="housecup-actions">
                <button class="housecup-next" @onclick="CloseHouseCup">Tag mig tilbage til Hogwarts!</button>
            </div>

        </div>
    </div>
}


@code {
    private Quiz _quiz = null!;
    private Question? _question;
    private bool _showVideo = false;
    private string textClass = string.Empty;

    private readonly HashSet<string> _answered = new();
    private static string TileKey(int difficulty, string category) => $"{category}::{difficulty}";

    private enum House { Gryffindor, Slytherin, Ravenclaw, Hufflepuff }

    private readonly Dictionary<House, int> _housePoints = new()
        {
            [House.Gryffindor] = 0,
            [House.Slytherin] = 0,
            [House.Ravenclaw] = 0,
            [House.Hufflepuff] = 0,
        };

    private void CloseHouseCup()
    {
        _showHouseCup = false;
    }


    private readonly Dictionary<House, bool> _awardTicks = new()
        {
            [House.Gryffindor] = false,
            [House.Slytherin] = false,
            [House.Ravenclaw] = false,
            [House.Hufflepuff] = false,
        };

    private bool _showHouseCup = false;
    private Dictionary<House, int> _prevPoints = new();
    private Dictionary<House, int> _nextPoints = new();

    // --- FIX IS HERE: Multiplied by 100 to convert difficulty (1-5) to points (100-500) ---
    private int CurrentQuestionPoints =>
        _question is null ? 0 : _question.Difficulty * 100;

    private void ResetTicks()
    {
        _awardTicks[House.Gryffindor] = false;
        _awardTicks[House.Slytherin] = false;
        _awardTicks[House.Ravenclaw] = false;
        _awardTicks[House.Hufflepuff] = false;
    }

    private async Task AwardPointsAsync()
    {
        if (_question is null) return;
        MarkAnswered();

        _prevPoints = _housePoints.ToDictionary(k => k.Key, v => v.Value);

        var points = CurrentQuestionPoints;

        foreach (var house in _awardTicks.Where(x => x.Value).Select(x => x.Key))
            _housePoints[house] += points;

        _nextPoints = _housePoints.ToDictionary(k => k.Key, v => v.Value);

        _showHouseCup = true;

        await InvokeAsync(StateHasChanged);
        await Task.Delay(50);
        await JSRuntime.InvokeVoidAsync("houseCupAnimate");
        await JSRuntime.InvokeVoidAsync("houseCupDiamonds");

        _showVideo = false;
        textClass = string.Empty;
        ResetTicks();
    }


    private bool IsAnswered(int difficulty, string category)
        => _answered.Contains(TileKey(difficulty, category));

    private string GetTileTdClass(int difficulty, string category)
        => IsAnswered(difficulty, category) ? "tile-answered" : string.Empty;

    private int P(Dictionary<House, int> d, House h) => d.TryGetValue(h, out var v) ? v : 0;

    protected async override Task OnInitializedAsync()
    {
        _quiz = quizContainer.Quiz;
        _quiz = await quizService.GetQuizQuestionsAsync(_quiz);
        _prevPoints = _housePoints.ToDictionary(x => x.Key, x => x.Value);
        _nextPoints = _housePoints.ToDictionary(x => x.Key, x => x.Value);
    }

    private record TubeCol(string Css, string Label, int FromPct, int ToPct, int To, int Delta);

    private IEnumerable<TubeCol> HouseCupColumns()
    {
        var max = Math.Max(1, _nextPoints.Values.DefaultIfEmpty(1).Max());

        TubeCol Make(House h, string label, string css)
        {
            var from = P(_prevPoints, h);
            var to = P(_nextPoints, h);

            var fromPct = (int)Math.Round((from / (double)max) * 100);
            var toPct = (int)Math.Round((to / (double)max) * 100);

            return new TubeCol(css, label, fromPct, toPct, to, to - from);
        }

        yield return Make(House.Gryffindor, "Gryffindor", "gryff");
        yield return Make(House.Slytherin, "Slytherin", "slyth");
        yield return Make(House.Ravenclaw, "Ravenclaw", "raven");
        yield return Make(House.Hufflepuff, "Hufflepuff", "huff");
    }

    private async Task ShowQuestion(int difficulty, string category)
    {
        if (IsAnswered(difficulty, category))
            return;

        ResetTicks();

        _showVideo = true;
        _question = _quiz.Questions.FirstOrDefault(q => q.Difficulty == difficulty && q.Category == category);

        if (_question is null)
            return;

        textClass = string.Empty;

        await Task.Delay(100);
        await JSRuntime.InvokeVoidAsync("playVideo");

        await Task.Delay(2000);
        textClass = "fade-in-text";
    }

    private void HideQuestion()
    {
        _showVideo = false;
        textClass = string.Empty;
    }

    private async Task OnTileClick(int difficulty, string category)
    {
        if (IsAnswered(difficulty, category))
            return;

        await ShowQuestion(difficulty, category);
    }

    private void MarkAnswered()
    {
        if (_question is null) return;
        _answered.Add(TileKey(_question.Difficulty, _question.Category));
    }
}