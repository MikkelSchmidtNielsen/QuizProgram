@page "/jeopardy"
@implements IDisposable
@rendermode InteractiveServer
@inject IQuizContainer quizContainer
@inject IQuizService quizService
@inject IGameService gameService
@inject IJSRuntime JSRuntime

<div class="jeopardy-board" id="jeopardy-board">

    <audio id="rulesAudio" preload="auto">
        <source src="audio/rules.mp3" type="audio/mpeg" />
    </audio>
    <audio id="thanksAudio" preload="auto">
        <source src="audio/thanks.mp3" type="audio/mpeg" />
    </audio>

    <div class="bg-video">
        <video id="bgVideo1" class="bg-layer active" autoplay muted playsinline preload="auto">
            <source src="video/wallpaper.mp4" type="video/mp4" />
        </video>
        <video id="bgVideo2" class="bg-layer" muted playsinline preload="auto">
            <source src="video/wallpaper.mp4" type="video/mp4" />
        </video>
    </div>

    <h1>Potter 'n' Pipes</h1>

    @if (!_showPodium)
    {
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <td width="250">Halfblood prince</td>
                        <td width="250">Hogwarts History</td>
                        <td width="250">Muggles World</td>
                        <td width="250">Four Houses of Hogwarts</td>
                        <td width="250">Random Pipes</td>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 1; i <= 5; i++)
                    {
                        var currentDifficulty = i;
                        <tr>
                            <td class="@GetTileTdClass(currentDifficulty, "Halfblood prince")">
                                <p @onclick="@(() => OnTileClick(currentDifficulty, "Halfblood prince"))">@(currentDifficulty * 100)</p>
                            </td>
                            <td class="@GetTileTdClass(currentDifficulty, "Hogwarts History")">
                                <p @onclick="@(() => OnTileClick(currentDifficulty, "Hogwarts History"))">@(currentDifficulty * 100)</p>
                            </td>
                            <td class="@GetTileTdClass(currentDifficulty, "Muggles World")">
                                <p @onclick="@(() => OnTileClick(currentDifficulty, "Muggles World"))">@(currentDifficulty * 100)</p>
                            </td>
                            <td class="@GetTileTdClass(currentDifficulty, "Four Houses of Hogwarts")">
                                <p @onclick="@(() => OnTileClick(currentDifficulty, "Four Houses of Hogwarts"))">@(currentDifficulty * 100)</p>
                            </td>
                            <td class="@GetTileTdClass(currentDifficulty, "Random Pipes")">
                                <p @onclick="@(() => OnTileClick(currentDifficulty, "Random Pipes"))">@(currentDifficulty * 100)</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    @if (_showVideo)
    {
        <div class="video-container" @onclick="HideQuestion">
            <video id="bookVideo" class="fullscreen-video" autoplay muted playsinline>
                <source src="video/book.mp4" type="video/mp4" />
            </video>

            <div class="overlay-text @textClass" @onclick:stopPropagation="true">
                <h2>@_question.Text</h2>
            </div>

            <div class="expelliarmus-wrapper" @onclick:stopPropagation="true">
                <div class="expelliarmus-panel">
                    @if (_castingHouse == null)
                    {
                        <div class="expelliarmus-header">Expelliarmus</div>
                        <div class="expelliarmus-list">
                            @foreach (var house in Enum.GetValues<House>())
                            {
                                var isUsed = _expelliarmusUsed[house];
                                <button class="expelliarmus-btn @GetHouseCss(house) @(isUsed ? "used" : "")"
                                        @onclick="() => PrepareExpelliarmus(house)"
                                        disabled="@isUsed">
                                    <img src="/images/@(GetHouseCss(house)).png" class="mini-crest" />
                                    <span>@house</span>
                                    @if (isUsed)
                                    {
                                        <span class="used-mark">Used</span>
                                    }
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="expelliarmus-header">@_castingHouse Casts On...</div>
                        <div class="expelliarmus-list">
                            @foreach (var target in Enum.GetValues<House>())
                            {
                                if (target != _castingHouse)
                                {
                                    <button class="expelliarmus-btn target @GetHouseCss(target)"
                                            @onclick="() => CastExpelliarmus(target)">
                                        <img src="/images/@(GetHouseCss(target)).png" class="mini-crest" />
                                        <span>@target</span>
                                    </button>
                                }
                            }
                        </div>
                        <button class="regret-btn" @onclick="CancelExpelliarmus">Regret (Cancel)</button>
                    }
                </div>
            </div>

            <div class="award-wrapper" @onclick:stopPropagation="true">
                <div class="award-panel">
                    <div class="award-title">Award @CurrentQuestionPoints points</div>

                    @foreach (var house in Enum.GetValues<House>())
                    {
                        var isBlocked = IsBlocked(house);

                        <label class="house-tick @GetHouseCss(house) @(isBlocked ? "blocked" : "")">
                            @if (!isBlocked)
                            {
                                <input type="checkbox" @bind="_awardTicks[house]" />
                            }
                            else
                            {
                                <input type="checkbox" disabled checked="false" />
                            }
                            @house
                        </label>
                    }

                    <button class="award-btn" @onclick="AwardPointsAsync">Award points</button>
                </div>
            </div>
        </div>
    }

    @if (_showHouseCup)
    {
        <div class="housecup-overlay">
            <div class="housecup-card">
                <div class="housecup-title">House Cup</div>

                <div class="cups">
                    @foreach (var col in HouseCupColumns())
                    {
                        <div class="tube @col.Css"
                             data-delta="@col.Delta"
                             data-points="@col.To">

                            <div class="tube-frame"></div>

                            <div class="tube-glass">
                                <div class="diamond-layer"></div>
                                <div class="tube-highlight"></div>
                            </div>

                            <div class="tube-cap top"></div>
                            <div class="tube-cap bottom"></div>

                            <div class="tube-badge">
                                <img src="/images/@(col.Css).png" class="house-crest" alt="@col.Label" />
                                <div class="tube-house">@col.Label</div>
                                <div class="tube-score">@col.To</div>
                            </div>
                        </div>
                    }
                </div>

                <div class="housecup-actions">
                    <button class="housecup-next" @onclick="CloseHouseCup">Ulykke forbi</button>
                </div>

            </div>
        </div>
    }

    @if (_showRules)
    {
        <div class="rules-overlay @(_isSayingGoodbye ? "goodbye-mode" : "")" @onclick="CloseRules">
            @if (!_isSayingGoodbye)
            {
                <div class="rules-content-box" @onclick:stopPropagation="true">
                    <button class="rules-close-btn" @onclick="CloseRules">✖</button>
                    <div class="rules-text-section">
                        <h2>Regler:</h2>
                        <ul class="rules-list">
                            <li>Et hus vælger kategori og pointstørrelse</li>
                            <li>Alle huse har mulighed for at svare</li>
                            <li>Turen går videre til næste hus med uret, som dernæst vælger</li>
                            <li>Expelliarmus fratager et hus at svare på det gældende spørgsmål</li>
                            <li>Expelliarmus kan benyttes en gang</li>
                        </ul>
                    </div>
                    <div class="rules-image-section">
                        <img src="/images/dumbledore-standing.png" class="rules-dumbledore-img" alt="Dumbledore" />
                    </div>
                </div>
            }
            else
            {
                <div class="dumbledore-solo-container">
                    <img src="/images/dumbledore-standing.png" class="dumbledore-solo talking" alt="Dumbledore Speaking" />
                </div>
            }
        </div>
    }

    @if (_showPodium && _ranks.Any())
    {
        <div class="podium-overlay">

            @if (_showWinnerAnnouncement)
            {
                <div class="winner-text-anim">And the house cup goes to...</div>
            }

            <div class="podium-stage">
                <div class="podium-column second @(_reveal2nd ? "visible" : "")">
                    <div class="podium-crest-wrapper">
                        <img src="/images/@(GetHouseCss(_ranks[1].House)).png" class="podium-crest" />
                    </div>
                    <div class="podium-block">
                        <div class="podium-rank">2</div>
                        <div class="podium-points">@_ranks[1].Points</div>
                    </div>
                </div>

                <div class="podium-column first @(_reveal1st ? "visible" : "")">
                    <div class="podium-crest-wrapper">
                        <img src="/images/@(GetHouseCss(_ranks[0].House)).png" class="podium-crest" />
                    </div>
                    <div class="podium-block">
                        <div class="podium-rank">1</div>
                        <div class="podium-points">@_ranks[0].Points</div>
                    </div>
                </div>

                <div class="podium-column third @(_reveal3rd ? "visible" : "")">
                    <div class="podium-crest-wrapper">
                        <img src="/images/@(GetHouseCss(_ranks[2].House)).png" class="podium-crest" />
                    </div>
                    <div class="podium-block">
                        <div class="podium-rank">3</div>
                        <div class="podium-points">@_ranks[2].Points</div>
                    </div>
                </div>
            </div>

            <img src="/images/dumbledore-standing.png" class="podium-dumbledore" />
        </div>
    }

</div>


@code {
    private Quiz _quiz = null!;
    private Question? _question;
    private bool _showVideo = false;
    private bool _showRules = false;
    private bool _isSayingGoodbye = false;
    private string textClass = string.Empty;

    // Podium State
    private bool _showPodium = false;
    private bool _reveal3rd = false;
    private bool _reveal2nd = false;
    private bool _reveal1st = false;
    private bool _showWinnerAnnouncement = false;
    private List<(House House, int Points)> _ranks = new();

    private readonly HashSet<string> _answered = new();
    private static string TileKey(int difficulty, string category) => $"{category}::{difficulty}";

    private enum House { Gryffindor, Slytherin, Ravenclaw, Hufflepuff }

    private readonly Dictionary<House, int> _housePoints = new()
        {
            [House.Gryffindor] = 0,
            [House.Slytherin] = 0,
            [House.Ravenclaw] = 0,
            [House.Hufflepuff] = 0,
        };

    private Dictionary<House, bool> _expelliarmusUsed = new();
    private House? _castingHouse = null;
    private House? _blockedHouse = null;

    private DotNetObjectReference<Jeopardy>? _dotNetRef;

    private string GetHouseCss(House h) => h switch
    {
        House.Gryffindor => "gryff",
        House.Slytherin => "slyth",
        House.Ravenclaw => "raven",
        House.Hufflepuff => "huff",
        _ => ""
    };

    private bool IsBlocked(House h) => _blockedHouse.HasValue && _blockedHouse.Value == h;

    private void PrepareExpelliarmus(House source)
    {
        if (!_expelliarmusUsed[source])
        {
            _castingHouse = source;
        }
    }

    private async Task CastExpelliarmus(House target)
    {
        if (_castingHouse.HasValue)
        {
            _expelliarmusUsed[_castingHouse.Value] = true;
            _blockedHouse = target;
            _awardTicks[target] = false;
            _castingHouse = null;
            await JSRuntime.InvokeVoidAsync("triggerExplosion");
        }
    }

    private void CancelExpelliarmus()
    {
        _castingHouse = null;
    }

    private void CloseHouseCup()
    {
        _showHouseCup = false;

        // CHECK FOR GAME OVER HERE
        // If we have answered all questions (assuming 5 rows * 5 cols = 25 questions)
        // Or strictly count based on quiz data
        if (_answered.Count >= _quiz.Questions.Count)
        {
            RunPodiumCeremony();
        }
    }

    private void CloseRules()
    {
        _showRules = false;
        _isSayingGoodbye = false;
    }

    private readonly Dictionary<House, bool> _awardTicks = new()
        {
            [House.Gryffindor] = false,
            [House.Slytherin] = false,
            [House.Ravenclaw] = false,
            [House.Hufflepuff] = false,
        };

    private bool _showHouseCup = false;
    private Dictionary<House, int> _prevPoints = new();
    private Dictionary<House, int> _nextPoints = new();

    private int CurrentQuestionPoints =>
        _question is null ? 0 : _question.Difficulty * 100;

    private void ResetTicks()
    {
        _awardTicks[House.Gryffindor] = false;
        _awardTicks[House.Slytherin] = false;
        _awardTicks[House.Ravenclaw] = false;
        _awardTicks[House.Hufflepuff] = false;
    }

    private async Task AwardPointsAsync()
    {
        if (_question is null) return;
        MarkAnswered();

        _prevPoints = _housePoints.ToDictionary(k => k.Key, v => v.Value);

        var points = CurrentQuestionPoints;

        foreach (var house in _awardTicks.Where(x => x.Value).Select(x => x.Key))
            _housePoints[house] += points;

        _nextPoints = _housePoints.ToDictionary(k => k.Key, v => v.Value);

        _showHouseCup = true;

        await InvokeAsync(StateHasChanged);
        await Task.Delay(50);
        await JSRuntime.InvokeVoidAsync("houseCupAnimate");
        await JSRuntime.InvokeVoidAsync("houseCupDiamonds");

        _showVideo = false;
        textClass = string.Empty;
        ResetTicks();
    }

    private async void RunPodiumCeremony()
    {
        // 1. Sort Houses
        _ranks = _housePoints
            .Select(x => (House: x.Key, Points: x.Value))
            .OrderByDescending(x => x.Points)
            .ToList();

        // 2. Initialize State
        _showPodium = true;
        _reveal3rd = false;
        _reveal2nd = false;
        _reveal1st = false;
        _showWinnerAnnouncement = false;
        StateHasChanged();

        // 3. Sequence
        await Task.Delay(1000);

        // Reveal 3rd
        _reveal3rd = true;
        StateHasChanged();
        await Task.Delay(2500);

        // Reveal 2nd
        _reveal2nd = true;
        StateHasChanged();
        await Task.Delay(2500);

        // Announcement Text
        _showWinnerAnnouncement = true;
        StateHasChanged();
        await Task.Delay(3500);

        // Reveal 1st & Hide Text
        _showWinnerAnnouncement = false;
        _reveal1st = true;
        StateHasChanged();

        // CONFETTI!
        await JSRuntime.InvokeVoidAsync("triggerWinnerConfetti");
    }

    private bool IsAnswered(int difficulty, string category)
        => _answered.Contains(TileKey(difficulty, category));

    private string GetTileTdClass(int difficulty, string category)
        => IsAnswered(difficulty, category) ? "tile-answered" : string.Empty;

    private int P(Dictionary<House, int> d, House h) => d.TryGetValue(h, out var v) ? v : 0;

    protected async override Task OnInitializedAsync()
    {
        _quiz = quizContainer.Quiz;
        _quiz = await quizService.GetQuizQuestionsAsync(_quiz);
        _prevPoints = _housePoints.ToDictionary(x => x.Key, x => x.Value);
        _nextPoints = _housePoints.ToDictionary(x => x.Key, x => x.Value);

        foreach (var h in Enum.GetValues<House>())
        {
            _expelliarmusUsed[h] = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("initBackgroundLoop");
            await JSRuntime.InvokeVoidAsync("initSpeechRecognition", _dotNetRef);
        }
    }

    [JSInvokable]
    public async Task TriggerDumbledoreEvent()
    {
        _showRules = true;
        _isSayingGoodbye = false;
        StateHasChanged();
        await Task.Delay(2000);
        await JSRuntime.InvokeVoidAsync("playRulesAudio");
    }

    [JSInvokable]
    public void TriggerThanksEvent()
    {
        _isSayingGoodbye = true;
        StateHasChanged();
    }

    [JSInvokable]
    public void TriggerCloseRules()
    {
        _showRules = false;
        _isSayingGoodbye = false;
        StateHasChanged();
    }

    public void Dispose()
    {
        _dotNetRef?.Dispose();
    }

    private record TubeCol(string Css, string Label, int FromPct, int ToPct, int To, int Delta);

    private IEnumerable<TubeCol> HouseCupColumns()
    {
        var max = Math.Max(1, _nextPoints.Values.DefaultIfEmpty(1).Max());

        TubeCol Make(House h, string label, string css)
        {
            var from = P(_prevPoints, h);
            var to = P(_nextPoints, h);

            var fromPct = (int)Math.Round((from / (double)max) * 100);
            var toPct = (int)Math.Round((to / (double)max) * 100);

            return new TubeCol(css, label, fromPct, toPct, to, to - from);
        }

        yield return Make(House.Gryffindor, "Gryffindor", "gryff");
        yield return Make(House.Slytherin, "Slytherin", "slyth");
        yield return Make(House.Ravenclaw, "Ravenclaw", "raven");
        yield return Make(House.Hufflepuff, "Hufflepuff", "huff");
    }

    private async Task ShowQuestion(int difficulty, string category)
    {
        if (IsAnswered(difficulty, category))
            return;

        var foundQuestion = _quiz.Questions.FirstOrDefault(q => q.Difficulty == difficulty && q.Category == category);

        if (foundQuestion is null)
            return;

        _question = foundQuestion;
        ResetTicks();
        _castingHouse = null;
        _blockedHouse = null;

        _showVideo = true;
        textClass = string.Empty;

        await Task.Delay(100);
        await JSRuntime.InvokeVoidAsync("playVideo");

        await Task.Delay(2000);
        textClass = "fade-in-text";
    }

    private void HideQuestion()
    {
        _showVideo = false;
        textClass = string.Empty;
    }

    private async Task OnTileClick(int difficulty, string category)
    {
        if (IsAnswered(difficulty, category))
            return;

        await ShowQuestion(difficulty, category);
    }

    private void MarkAnswered()
    {
        if (_question is null) return;
        _answered.Add(TileKey(_question.Difficulty, _question.Category));
    }
}